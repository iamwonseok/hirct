# Task 108: gen-cocotb — Python Testbench 생성기

> **목표**: GenCocotb.cpp를 새로 작성하여 cocotb 기반 Python 테스트벤치를 자동 생성한다
> **예상 시간**: 1일
> **파일**: `lib/Target/GenCocotb.cpp` (신규)
> **TDD**: RED → GREEN → REFACTOR

---

## 현재 상태

- cocotb 테스트벤치 생성기 없음 (신규)
- ModuleAnalyzer에서 포트 목록 추출 가능 (재사용)

---

## Step 1: RED — GenCocotb 미존재 (5분)

**Goal**: GenCocotb 호출 시 산출물 없음 확인

**Run**:
```bash
hirct-gen rtl/plat/src/s5/design/Fadu_K2_S5_LevelGateway.v
ls output/plat/src/s5/design/Fadu_K2_S5_LevelGateway/cocotb/ 2>/dev/null || echo "no cocotb subdir"
```

**Expect**:
```
no cocotb subdir
```

---

## Step 2: GREEN — 최소 cocotb 스켈레톤 생성 (3시간)

**Goal**: IR 포트 정보로 cocotb 테스트 파일 자동 생성. DUT 포트 접근, 클럭/리셋 시퀀스, 기본 sanity test를 포함.

**출력 파일**: `cocotb/test_<ModuleName>.py`

**생성 템플릿 구조**:
```python
# AUTO-GENERATED by hirct-gen — DO NOT EDIT
import cocotb
from cocotb.clock import Clock
from cocotb.triggers import RisingEdge, Timer

@cocotb.test()
async def test_reset(dut):
    """Reset sanity: 리셋 후 출력이 정의된 값인지 확인"""
    clock = Clock(dut.<clock_port>, 10, units="ns")
    cocotb.start_soon(clock.start())
    dut.<reset_port>.value = 1
    await RisingEdge(dut.<clock_port>)
    await RisingEdge(dut.<clock_port>)
    dut.<reset_port>.value = 0
    await RisingEdge(dut.<clock_port>)
    # 출력 포트 읽기 (smoke check)
    # <output_port_reads>

@cocotb.test()
async def test_random_stimulus(dut):
    """Random stimulus: 랜덤 입력 후 타임아웃 없이 시뮬레이션 완료"""
    clock = Clock(dut.<clock_port>, 10, units="ns")
    cocotb.start_soon(clock.start())
    dut.<reset_port>.value = 1
    for _ in range(2):
        await RisingEdge(dut.<clock_port>)
    dut.<reset_port>.value = 0
    import random
    for _ in range(100):
        # <random_input_assignments>
        await RisingEdge(dut.<clock_port>)
```

**Run**:
```bash
cmake --build build
hirct-gen rtl/plat/src/s5/design/Fadu_K2_S5_LevelGateway.v
ls output/plat/src/s5/design/Fadu_K2_S5_LevelGateway/cocotb/
head -30 output/plat/src/s5/design/Fadu_K2_S5_LevelGateway/cocotb/test_*.py
```

**Expect**:
```
test_LevelGateway.py (또는 test_Fadu_K2_S5_LevelGateway.py)
cocotb import 구문 + @cocotb.test() 데코레이터 + DUT 포트 접근 코드
```

---

## Step 3: 구문 검증 (15분)

**Goal**: 생성된 Python 파일이 유효한 구문인지 확인 (cocotb 설치 불필요)

**Run**:
```bash
python3 -m py_compile output/plat/src/s5/design/Fadu_K2_S5_LevelGateway/cocotb/test_*.py
echo "Exit: $?"
```

**Expect**:
```
Exit: 0
```

---

## Step 4: 클럭/리셋 포트 자동 탐지 (1시간)

**Goal**: hirct-convention.md §2.1의 클럭/리셋 패턴을 적용하여 포트를 자동 분류

**검증 포인트**:
- `clock`/`clk` 패턴 → `Clock()` 인스턴스에 사용
- `reset`/`rst` 패턴 → 리셋 시퀀스에 사용
- `reset_n`/`rst_n` → active-low 리셋 처리 (0 = reset)
- 나머지 입력 포트 → 랜덤 stimulus 대상

**Run**:
```bash
hirct-gen rtl/plat/src/s5/design/Fadu_K2_S5_LevelGateway.v
grep -E "Clock\(dut\.|\.value = " output/plat/src/s5/design/Fadu_K2_S5_LevelGateway/cocotb/test_*.py
```

**Expect**:
```
Clock(dut.clock, ...) 또는 Clock(dut.clk, ...)
dut.reset.value = 1 (또는 dut.reset_n.value = 0)
```

---

## Step 5: 커밋

**Run**:
```bash
git add lib/Target/GenCocotb.cpp include/hirct/Target/GenCocotb.h lib/Target/CMakeLists.txt
git commit -m "feat(phase-1): GenCocotb - auto-generate cocotb Python testbench skeleton"
```

---

## 게이트 (완료 기준)

- [ ] `hirct-gen rtl/plat/src/s5/design/Fadu_K2_S5_LevelGateway.v` → `output/.../cocotb/test_*.py` 존재
- [ ] `python3 -m py_compile output/.../cocotb/test_*.py` → exit 0 (구문 검증)
- [ ] 생성 파일 첫 줄: `# AUTO-GENERATED by hirct-gen — DO NOT EDIT`
- [ ] 클럭/리셋 포트가 hirct-convention.md §2.1 패턴에 따라 자동 탐지됨
- [ ] cocotb 환경 사용 가능 시 실제 실행 PASS (선택)
- [ ] GenCocotb.cpp 구현 + CMakeLists.txt 수정 완료
- [ ] `test/Target/GenCocotb/` lit 테스트 최소 1개 PASS

---

## 변경 이력

| 날짜 | 내용 |
|------|------|
| 2026-02-15 | 초안 (게이트만) |
| 2026-02-16 | 구현 스텝 추가 (RED/GREEN/REFACTOR), 생성 템플릿 구조 명시, 클럭/리셋 자동 탐지 스텝 추가 |
