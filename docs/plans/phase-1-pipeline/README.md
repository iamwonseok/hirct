# Phase 1: 파이프라인 기능 구현

> **예상 기간**: 28.5일 (Phase 1A: 16일 + Phase 1B: 12.5일)
> **진입 조건**: Phase 0 완료
> **완료 기준**: 모든 gen-xxx가 최소 1개 모듈에서 올바른 산출물 생성 + hirct-verify PASS
>
> **구조**: Phase 1A(core pipeline)에서 핵심 관통을 먼저 안정화한 뒤, Phase 1B(remaining emitters)를 추가한다.
> Phase 1B는 Phase 2 초반과 병행 가능하다.

---

## 목표

hirct-gen의 각 기능을 TDD로 구현/강화한다. 각 태스크 = hirct-gen의 기능 하나.

---

## Phase 1A Getting Started (CIRCT 스타일)

> CIRCT 문서의 "Getting Started" 흐름처럼 `준비 → 빌드 → 스모크 테스트 → lit/gtest` 순서로 실행한다.

### 1) 준비

```bash
export CIRCT_BUILD="$HOME/circt/build"
export PATH="$CIRCT_BUILD/bin:$PATH"
```

필수 도구:
- `circt-verilog`, `circt-opt`, `FileCheck`, `lit`, `ninja`, `cmake`

### 2) 빌드

```bash
cmake -B build -G Ninja
cmake --build build
```

성공 기준:
- `build/bin/hirct-gen` 생성
- `build/bin/hirct-verify` 생성

### 3) CLI 스모크 테스트

```bash
build/bin/hirct-gen --help
build/bin/hirct-verify --help
```

성공 기준:
- 두 명령 모두 exit 0

### 4) Phase 1A 테스트 실행

```bash
# lit(FileCheck) 단위 테스트
ninja -C build check-hirct

# gtest 단위 테스트
ninja -C build check-hirct-unit
```

성공 기준:
- `check-hirct`: PASS
- `check-hirct-unit`: PASS
- `build/lit-check.xml` 생성 (`check-hirct` 실행 시)

### 5) 루트 진입점으로 재실행 (회귀 확인)

```bash
make build
make check-hirct
make check-hirct-unit
```

---

## 파이프라인 흐름 (RTL → 산출물)

```
Verilog/SV (.v)
     │
     ▼
circt-verilog (Slang)  ─── 파싱 + Elaboration
     │
     ▼
CIRCT IR (.mlir)
     │
     ├── circt-opt --hw-flatten-modules  ─── (hw.instance 존재 시, 계층 인라인)
     │
     ▼
ModuleAnalyzer  ─── 포트/연산/레지스터/인스턴스 추출 + 토폴로지 정렬
     │
     ▼
hirct-gen (Emitter Loop)  ─── 8종 emitter 순차 호출 + meta.json 기록
     │
     ├── GenModel     → cmodel/   (.h + .cpp)
     ├── GenTB        → tb/       (.sv)
     ├── GenDPIC      → dpi/      (.h + .cpp + .sv)
     ├── GenWrapper   → wrapper/  (.sv)
     ├── GenFormat    → rtl/      (.v)
     ├── GenDoc       → doc/      (.md)
     ├── GenRAL       → ral/      (_ral.sv + _hal.h + _driver.c)  [조건부]
     ├── GenCocotb    → cocotb/   (.py)
     ├── GenVerify    → verify/   (verify_<module>.cpp)            [hirct-verify 시]
     └── GenMakefile  → ./        (Makefile)
```

## Emitter 인터페이스 계약 (Interface Contract)

모든 emitter는 아래 공통 계약을 준수한다:

| 계약 | 설명 |
|------|------|
| **입력** | `ModuleAnalyzer&` 참조 (포트·op·인스턴스 정보 포함) |
| **출력 디렉토리** | `output/<path>/<file>/<emitter별 서브디렉토리>/` |
| **헤더** | 모든 생성 파일 첫 줄에 `// AUTO-GENERATED by hirct-gen — DO NOT EDIT` |
| **에러 처리** | 실패 시 `meta.json`에 `"fail"` + reason 기록, 다음 emitter는 계속 실행 |
| **스킵** | 조건 미충족 시 `"skipped"` + reason 기록 (예: GenRAL 레지스터 없음) |
| **반환** | `bool` (true = 성공, false = 실패) |

**GenModel 인터페이스** (다른 emitter들의 의존 대상):

```cpp
class <ModuleName> {
public:
    // 포트 멤버 (IR 포트와 1:1 대응)
    <type> <port_name>;  // 입출력 포트

    // 필수 API
    void do_reset();     // 리셋 상태로 초기화
    void step();         // 1 사이클 실행 (posedge clock)

    // GenDPIC가 의존하는 시그니처
    void eval_comb();    // 조합 논리만 평가 (선택적)
};
```

## 실행 순서 및 의존 관계

### Phase 1A — Core Pipeline

```
100(Bootstrap) → [110 + 111] → 101 → 102 → 106 → 109
```

- **100(Bootstrap)**: **최초 필수**. CMakeLists.txt, ModuleAnalyzer, CirctRunner, 최소 GenModel, CLI main.cpp를 신규 작성하여 `hirct-gen --help` exit 0 달성. MLIR 정규화 파이프라인(`circt-verilog | circt-opt --canonicalize`)도 여기서 설계. 이 저장소에는 C++ 소스 코드가 아직 존재하지 않으므로, 이 태스크가 모든 후속 태스크의 전제조건이다.
- **110(output-structure) + 111(CLI)**: 100에서 생성한 스켈레톤을 확장. 동시 구현 필수. 모든 emitter의 출력 경로/CLI 기반.
- **101(gen-model)**: 핵심 emitter 신규 작성. 109(verify)의 전제.
- **102(gen-tb)**: 난이도 낮음(1일), SV 테스트벤치 템플릿. 101 이후 바로 진행.
- **106(gen-doc)**: 난이도 낮음(1.5일), 마크다운 문서 생성. 독립적.
- **109(verify)**: 101(cmodel)에 의존. **Phase 1A의 최종 관통 증명**.

### Phase 1B — Remaining Emitters (Phase 2와 병행 가능)

```
{103, 104, 105, 107, 108}  (서로 독립. 조사/리뷰는 병렬 가능. 코드 변경 적용(커밋/머지)은 순차 권장)
```

- **103(gen-dpic)**: 101의 GenModel 인터페이스(do_reset/step/eval_comb)에 의존. Phase 3 VCS co-sim 전제.
- **104(gen-wrapper)**: 포트 그룹핑 휴리스틱. 난이도 높음.
- **105(gen-format)**: scope 확정 (CIRCT ExportVerilog 기반, `risk-validation-results.md` §3 참조). 주석 삽입 로직이 본체.
- **107(gen-ral)**: 레지스터 탐지 + UVM RAL. 난이도 높음.
- **108(gen-cocotb)**: Python 테스트벤치 템플릿. 난이도 낮음.

---

## Agent-in-the-Loop 체크포인트

Phase 1A 실행 시, 아래 3개 체크포인트에서 사람 리뷰를 수행한다.
각 체크포인트는 **자동 Gate**(make 타겟/exit code로 판정)와 **수동 Gate**(사람이 직접 확인)로 구분한다.

### Checkpoint 1: Bootstrap 완료 (Task 100 후)

| 구분 | 검증 항목 | 판정 방법 |
|------|---------|---------|
| 자동 | `cmake --build build` exit 0 | make build |
| 자동 | `hirct-gen --help` exit 0 | CLI 실행 |
| 수동 | CMakeLists.txt 설계 리뷰 | 사람 확인 |
| 수동 | 디렉토리 구조(include/hirct/, lib/, tools/) 확인 | 사람 확인 |

**배치**: Task 100 단독 실행.

### Checkpoint 2: Core Pipeline 관통 (Task 101+110+111+109 후)

| 구분 | 검증 항목 | 판정 방법 |
|------|---------|---------|
| 자동 | `hirct-gen input.v` → cmodel/ + meta.json 생성 | 파일 존재 확인 |
| 자동 | `hirct-verify input.v` → 10시드 x 1000cyc PASS | exit 0 |
| 자동 | `make check-hirct` → lit 단위 테스트 PASS | exit 0 |
| 자동 | `make check-hirct-unit` → gtest PASS | exit 0 |
| 수동 | 생성된 C++ 모델 코드 품질 리뷰 | 사람 확인 |
| 수동 | 아키텍처 결정(CirctRunner, ModuleAnalyzer, Emitter 인터페이스) 재확인 | 사람 확인 |

**배치**: Task 110 → 111 → 101 순차 실행 (서브에이전트 1개씩. 110+111은 출력 구조/CLI이므로 순서 의존성이 있어 동시가 아닌 순차), 이후 Task 102 → 106 → 109 순차 실행.
**핵심**: RTL → C++ → Verilator 비교까지 전체 파이프라인이 관통하는지 검증하는 가장 중요한 체크포인트.

### Checkpoint 3: Phase 1A 완료 게이트 (Task 102+106 후)

| 구분 | 검증 항목 | 판정 방법 |
|------|---------|---------|
| 자동 | summary.md Phase 1A 완료 게이트 5개 항목 전부 | make test-all 구성 요소 |
| 수동 | Phase 1B/Phase 2 병행 진입 준비 판정 | 사람 확인 |
| 수동 | 기술 부채 리뷰 (TODO, 임시 코드, 성능 우려) | 사람 확인 |

**이 체크포인트를 통과해야 Phase 1B 및 Phase 2를 시작할 수 있다.**

---

## Phase 1B Agent-in-the-Loop

Phase 1B는 사람 체크포인트 없이 `subagent-driven-development`로 순차 실행한다.
5개 emitter가 서로 독립이므로 spec/quality 자동 리뷰만으로 충분하다.

**실행 순서**: 103(dpic) → 104(wrapper) → 105(format) → 107(ral) → 108(cocotb)

**리뷰 절차** (각 emitter 완료 시):
1. Spec reviewer: 태스크 문서의 게이트 기준 충족 여부
2. Code quality reviewer: C++ 코드 품질

**Phase 1B 완료 게이트** (사람이 최종 확인):
- 모든 emitter가 LevelGateway에서 올바른 산출물 생성
- 다양성 게이트: 5축 × 1개+ 모듈 PASS (summary.md §Phase 1 전체 완료 게이트 참조)

---

## 태스크

### Phase 1A — Core Pipeline (16일)

| ID | 태스크 | hirct-gen 기능 | 예상 시간 |
|----|--------|--------------|----------|
| **100** | **[bootstrap](100-bootstrap.md)** | **CMake 빌드 + CirctRunner + ModuleAnalyzer + 최소 GenModel + CLI 스켈레톤** | **3일** |
| 110 | [output-structure](110-output-structure.md) | 출력 디렉토리 구조 | 1일 |
| 111 | [cli](111-cli.md) | hirct-gen / hirct-verify CLI | 1.5일 |
| 101 | [gen-model](101-gen-model.md) | C++ cycle-accurate 모델 생성기 (IR op 커버리지 확장) | 5일 |
| 102 | [gen-tb](102-gen-tb.md) | SV 테스트벤치 골격 생성기 | 1일 |
| 106 | [gen-doc](106-gen-doc.md) | HW 문서 + 프로그래머 가이드 생성기 | 1.5일 |
| 109 | [verify](109-verify.md) | 자동 검증 (hirct-verify) | 3일 |

### Phase 1B — Remaining Emitters (12.5일, Phase 2와 병행 가능)

| ID | 태스크 | hirct-gen 기능 | 예상 시간 |
|----|--------|--------------|----------|
| 103 | [gen-dpic](103-gen-dpic.md) | DPI-C VCS 래퍼 생성기 | 2일 |
| 104 | [gen-wrapper](104-gen-wrapper.md) | SV Interface 래퍼 생성기 | 3일 |
| 105 | [gen-format](105-gen-format.md) | IR 기반 RTL 포매터 | 3일 |
| 107 | [gen-ral](107-gen-ral.md) | UVM RAL + HAL + C 드라이버 생성기 | 3일 |
| 108 | [gen-cocotb](108-gen-cocotb.md) | Python testbench 생성기 | 1.5일 |

---

## C++ 소스 매핑

> **Note**: 이 저장소에는 C++ 소스 코드가 존재하지 않는다.
> 이전 프로토타입(EmitCppModel.cpp 등)의 로직을 참고하여 v2 구조로 **처음부터 신규 작성**한다.
> Bootstrap(Task 100)에서 기본 스켈레톤을 생성하고, 각 태스크에서 기능을 추가한다.

| 기능 | v2 경로 | 생성 태스크 | 상태 |
|---|---|---|---|
| ModuleAnalyzer | lib/Analysis/ModuleAnalyzer.cpp | Task 100 (Bootstrap) | **신규** |
| CirctRunner | lib/Support/CirctRunner.cpp | Task 100 (Bootstrap) | **신규** |
| gen-model | lib/Target/GenModel.cpp | Task 100 (스켈레톤) + Task 101 (완성) | **신규** |
| gen-tb | lib/Target/GenTB.cpp | Task 102 | **신규** |
| gen-dpic | lib/Target/GenDPIC.cpp | Task 103 | **신규** |
| gen-wrapper | lib/Target/GenWrapper.cpp | Task 104 | **신규** |
| gen-format | lib/Target/GenFormat.cpp | Task 105 | **신규** |
| gen-doc | lib/Target/GenDoc.cpp | Task 106 | **신규** |
| gen-ral | lib/Target/GenRAL.cpp | Task 107 | **신규** |
| gen-cocotb | lib/Target/GenCocotb.cpp | Task 108 | **신규** |
| verify | lib/Target/GenVerify.cpp | Task 109 | **신규** |
| Makefile 생성 | lib/Target/GenMakefile.cpp | Task 100 (스켈레톤) + Task 110 (완성) | **신규** |
| CLI (hirct-gen) | tools/hirct-gen/main.cpp | Task 100 (스켈레톤) + Task 111 (완성) | **신규** |
| CLI (hirct-verify) | tools/hirct-verify/main.cpp | Task 100 (스켈레톤) + Task 109 (완성) | **신규** |

---

## 성공 기준

### Phase 1A 완료 게이트 (Phase 1B/2 진입 조건)

- [ ] `hirct-gen input.v` → cmodel/ + tb/ + doc/ + meta.json + Makefile 생성
- [ ] `hirct-verify input.v` → 10시드 x 1000cyc PASS (LevelGateway + RVCExpander)
- [ ] `make check-hirct` → lit 단위 테스트 PASS
- [ ] `g++ -c output/.../cmodel/*.cpp` → 컴파일 성공
- [ ] `make check-hirct-unit` → gtest C++ API 단위 테스트 PASS

### Phase 1 전체 완료 게이트 (Phase 1A + 1B)

- [ ] 모든 Gen*.cpp가 LevelGateway에서 올바른 산출물 생성
- [ ] hirct-gen input.v → 소스 트리 미러링 디렉토리에 전체 산출물 생성
- [ ] 각 산출물이 해당 컨벤션 준수
- [ ] 다양성 게이트: 아래 5축에서 각 1개+ 모듈 PASS
  - 소형 모듈 (포트 10개 미만)
  - 중형 모듈 (포트 30~100개)
  - 레지스터 포함 모듈 (GenRAL 생성 대상)
  - 다중 인스턴스(hw.instance) 포함 모듈
  - 파라미터(hw.param) 사용 모듈

---

## 테스트 Fixture 확장 계획

Phase 1에서 사용하는 `test/fixtures/` MLIR 픽스처는 Task별로 점진적으로 확장한다:

| Fixture | 특성 | 생성 시점 |
|---------|------|----------|
| `LevelGateway.mlir` | 소형, 레지스터 1개, 조합 로직 | Task 100 |
| `RVCExpander.mlir` | 중형, 다수 레지스터, 복잡 조합 로직 | Task 100 |
| `CombOnly.mlir` | 순수 조합 로직 (클럭 없음) | Task 101 |
| `WideSignal.mlir` | 65비트+ 신호 포함 | Task 101 |
| `MultiModule.mlir` | 다중 모듈 (--top 필요) | Task 111 |
| `RegisterBlock.mlir` | CSR 레지스터 블록 패턴 | Task 107 |
| `ArrayOps.mlir` | hw.array_create/inject/get 포함 | Task 101 |

> **원칙**: 각 emitter의 lit 테스트(`test/Target/Gen*/`)는 가능한 한 이 fixture를 재사용한다. 특수 케이스만 인라인 MLIR을 사용한다.
