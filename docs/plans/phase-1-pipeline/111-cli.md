# Task 111: hirct-gen / hirct-verify CLI 인터페이스

> **목표**: hirct-gen과 hirct-verify의 CLI를 확정하고 통합한다
> **예상 시간**: 1일
> **파일**: `tools/hirct-gen/main.cpp`, `tools/hirct-verify/main.cpp` (별도 바이너리)
> **TDD**: RED → GREEN → REFACTOR

---

## 현재 상태

- Task 100(Bootstrap)에서 `tools/hirct-gen/main.cpp`, `tools/hirct-verify/main.cpp` 최소 CLI 생성 완료. 이 태스크에서 `--only`, `--top`, `-f` 옵션 등을 추가하여 CLI를 완성한다.

---

## 목표

### hirct-gen

```bash
hirct-gen input.v                    # 전체 산출물 생성 (기본)
hirct-gen input.v -o output/path     # 출력 경로 지정
hirct-gen -f filelist.f              # 다중 파일 / Top
hirct-gen input.v --only model,tb    # 선택적 필터 (Phase 1 필수)
```

기본 동작: 입력 파일 → MLIR 생성 → 8종 산출물 + Makefile → 소스 트리 미러링 디렉토리에 출력

**--only 옵션** (Phase 1 필수):
- 구문: `--only model,tb,doc` (쉼표 구분)
- 지원 필터: `model`, `tb`, `dpic`, `wrapper`, `format`, `doc`, `ral`, `cocotb`
- 잘못된 필터명 → Error + 유효 목록 출력

**--top 옵션** (조건부 필수):

| 모드 | 조건 | `--top` |
|------|------|---------|
| `hirct-gen input.v` | 파일 내 모듈 1개 | 자동 지정 (불필요) |
| `hirct-gen input.v` | 파일 내 모듈 2개+ | **필수** (미지정 시 Error) |
| `hirct-gen -f filelist.f` | 항상 | **필수** (미지정 시 Error) |

**filelist.f 형식** (Synopsys/Cadence 표준 호환):
- `//` 주석
- `+incdir+<path>` include 경로
- 한 줄에 파일 경로 하나
- 와일드카드 미지원 (명시적 경로만)

**filelist → circt-verilog 변환** (hirct-gen 내부):

> `circt-verilog`는 `-f filelist.f`를 지원하지 않으므로, hirct-gen이 filelist를 자체 파싱하여 multi-file 인자로 변환한다. (실측: `risk-validation-results.md` §5)

1. filelist.f 파싱: 주석(`//`) 제거, `+incdir+<path>` 수집, 파일 경로 목록 추출
2. multi-file 모드 timescale 기본값 주입: `1ns/1ps` (사용자 오버라이드 가능)
3. CirctRunner 호출: `circt-verilog --timescale=<ts> --top=<top> file1.v file2.v ...`

**`--timescale` 옵션**:

```bash
hirct-gen -f filelist.f --top CoreIP                      # 기본 1ns/1ps
hirct-gen -f filelist.f --top CoreIP --timescale 1ps/1ps  # 오버라이드
```

### hirct-verify

> **바이너리**: `tools/hirct-verify/main.cpp` (hirct-gen과 별도 바이너리)

hirct-gen이 생성한 C++ 모델이 원본 RTL과 cycle-accurate하게 일치하는지 자동 검증한다. Verilator RTL 모델을 골든 레퍼런스로 사용하며, 동일 입력에 대해 양쪽 출력을 매 사이클 직접 비교한다.

**내부 동작:**

1. hirct-gen으로 cmodel 생성 (이미 있으면 스킵)
2. Verilator로 RTL → C++ 시뮬레이션 모델 빌드
3. IR 포트 정보로 `verify_<module>.cpp` (비교 드라이버) 자동 생성
4. 드라이버 빌드 (cmodel + verilator obj 링크)
5. 다중 시드 x N사이클 실행, PASS/FAIL 리포트

```bash
hirct-verify input.v                 # 자동 검증 (10시드 x 1000cyc)
hirct-verify input.v --seeds 5       # 시드 수 조정
hirct-verify input.v --cycles 100    # 사이클 수 조정
```

동일한 검증은 per-module 디렉토리에서도 실행 가능:

```bash
cd output/<path>/<module>/
make test-verify
```

### 루트 Makefile 타겟

```makefile
make build                     # hirct-gen/hirct-verify 빌드 (CMake + Ninja)
make generate                  # filelist 기반 산출물 생성 (config/generate.f)
make check-hirct               # lit test/ (emitter FileCheck)
make check-hirct-unit          # gtest (C++ API)
make check-hirct-integration   # lit integration_test/smoke/ (E2E)
make test-all                  # 위 전체 + report (CI 메인 진입점)
make test-traversal            # ~1600 .v 전체 순회 (Phase 2, CI 제외)
make lint                      # 코딩 컨벤션 점검
```

## Step 1: RED — 기존 CLI 상태 확인 (15분)

**Goal**: 현재 hirct-gen/hirct-verify CLI의 한계를 확인

**Run**:
```bash
hirct-gen --help 2>&1 | head -5
hirct-gen input.v --only model 2>&1 | head -3
```

**Expect**:
```
--only 옵션 미지원 또는 오류
```

---

## Step 2: GREEN — hirct-gen CLI 통합 (3시간)

**Goal**: Task 100 스켈레톤의 main.cpp를 확장하여 전체 emitter 체이닝 구현

**Run**:
```bash
cmake --build build
hirct-gen rtl/plat/src/s5/design/Fadu_K2_S5_LevelGateway.v
ls output/plat/src/s5/design/Fadu_K2_S5_LevelGateway/cmodel/
```

**Expect**:
```
.h + .cpp 파일 존재
```

---

## Step 3: GREEN — --only 필터 구현 (1시간)

**Goal**: 쉼표 구분 필터로 선택적 산출물 생성

**Run**:
```bash
hirct-gen rtl/plat/src/s5/design/Fadu_K2_S5_LevelGateway.v --only model
ls output/plat/src/s5/design/Fadu_K2_S5_LevelGateway/
```

**Expect**:
```
cmodel/ 만 존재, tb/ wrapper/ 등 미생성
```

---

## Step 4: GREEN — --top / -f 옵션 구현 (1시간)

**Goal**: filelist 모드에서 --top 필수 강제

**Run**:
```bash
hirct-gen -f filelist.f 2>&1 | head -3
```

**Expect**:
```
Error: --top is required when using -f
```

---

## Step 5: GREEN — hirct-verify 별도 바이너리 (1시간)

**Goal**: tools/hirct-verify/main.cpp 빌드 + 기본 동작

**Run**:
```bash
cmake --build build
hirct-verify rtl/plat/src/s5/design/Fadu_K2_S5_LevelGateway.v
```

**Expect**:
```
PASS: ... pass, 0 fail
```

---

## Step 6: 커밋

**Run**:
```bash
git add tools/hirct-gen/main.cpp tools/hirct-verify/main.cpp CMakeLists.txt
git commit -m "feat(phase-1): hirct-gen/hirct-verify CLI - --only, --top, -f, exit codes"
```

---

## Exit Code 규약

- 0: 성공 (모든 산출물 생성 완료)
- 1: 실패 (emitter 에러, 컴파일 에러 등)
- 2: 인프라 에러 (입력 파일 없음, CIRCT 도구 미설치 등)

---

## 게이트 (완료 기준)

- [ ] `hirct-gen --help` → 사용법 출력 (exit 0)
- [ ] `hirct-gen rtl/.../Fadu_K2_S5_LevelGateway.v` → 8종 산출물 올바른 디렉토리에 생성
- [ ] `hirct-verify rtl/.../Fadu_K2_S5_LevelGateway.v` → PASS/FAIL 리포트 출력
- [ ] `make build` → hirct-gen 바이너리 빌드 성공
- [ ] `make generate` → 전체 산출물 생성 성공
- [ ] `hirct-gen input.v --only model` → cmodel/ 만 생성, 나머지 미생성 확인
- [ ] `hirct-gen -f filelist.f` (--top 미지정) → Error 메시지 출력 확인
