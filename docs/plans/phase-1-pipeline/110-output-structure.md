# Task 110: 출력 디렉토리 구조

> **목표**: 입력 경로 독립 출력 구조. 단일 파일: output/<filename>/, filelist+top: output/<top_name>/
> **예상 시간**: 0.5일
> **파일**: tools/hirct-gen 출력 로직, lib/Target/
> **TDD**: RED → GREEN → REFACTOR

---

## RTL 경로 독립성

> **중요**: `rtl/` 디렉토리는 개발/테스트용 예제이다. 실제 환경에서 RTL은 임의 경로에 위치한다.
> 출력 경로는 입력 경로에 의존하지 않는다 (상세: `hirct-convention.md` §0 참조).

| 입력 모드 | 출력 경로 | 예시 |
|----------|----------|------|
| 단일 파일 | `output/<filename>/` | `output/uart_top/` |
| 단일 파일 + `-o` | `<output_dir>/<filename>/` | `custom/uart_top/` |
| filelist + `--top` | `output/<top_name>/` | `output/SocTop/` |
| `make generate` (순회) | `output/<relative_path>/<filename>/` | 소스 트리 미러링 |

---

## 현재 상태

- Task 100(Bootstrap)에서 최소 출력 구조 구현 완료. 이 태스크에서 경로 독립 출력 구조, 서브디렉토리, Top 출력을 완성한다.

---

## Step 1: RED — 현재 구조 확인 (15분)

**Goal**: 기존 출력 구조 파악

**Run**:
```bash
hirct-gen rtl/plat/src/s5/design/Fadu_K2_S5_LevelGateway.v
find output -type f | head -20
```

> **Implementation Note**: 개발 중 출력 경로 지정 가능: `hirct-gen rtl/plat/src/s5/design/Fadu_K2_S5_LevelGateway.v -o build/_scratch/out`

**Expect**:
```
현재 평탄/단일 구조
```

---

## Step 2: GREEN — 소스 경로 미러링 (2시간)

**Goal**: rtl/plat/src/s5/design/X.v → output/plat/src/s5/design/X/ 또는 output/<path>/X/

**Run**:
```bash
hirct-gen rtl/plat/src/s5/design/Fadu_K2_S5_LevelGateway.v
ls -la output/plat/src/s5/design/Fadu_K2_S5_LevelGateway/
```

> **Implementation Note**: 개발 중 출력 경로 지정 가능: `hirct-gen rtl/plat/src/s5/design/Fadu_K2_S5_LevelGateway.v -o build/_scratch/out`

**Expect**:
```
경로 구조 반영
```

---

## Step 3: 서브디렉터리 (cmodel, tb, dpi, wrapper, rtl, doc, cocotb) (1시간)

**Goal**: output/<path>/<file>/{cmodel,tb,dpi,wrapper,rtl,doc,cocotb}

**Run**:
```bash
hirct-gen rtl/plat/src/s5/design/Fadu_K2_S5_LevelGateway.v
ls output/plat/src/s5/design/Fadu_K2_S5_LevelGateway/
```

> **Implementation Note**: 개발 중 출력 경로 지정 가능: `hirct-gen rtl/plat/src/s5/design/Fadu_K2_S5_LevelGateway.v -o build/_scratch/out`

**Expect**:
```
cmodel/
tb/
dpi/
wrapper/
rtl/
doc/
cocotb/
```

---

## Step 4: Top 출력 (30분)

**Goal**: output/<path>/top/ 생성

**Run**:
```bash
hirct-gen -f rtl/plat/src/s5/design/filelist.f --top <TopModule>
ls output/plat/src/s5/design/top/
```

> **Implementation Note**: 개발 중 출력 경로 지정 가능: `hirct-gen -f rtl/plat/src/s5/design/filelist.f --top <TopModule> -o build/_scratch/out`

**Expect**:
```
top/ 디렉터리
```

---

## Step 5: Gate — hirct-gen input.v 정확한 디렉터리 (15분)

**Goal**: hirct-gen input.v 실행 시 의도한 구조 생성

**Run**:
```bash
hirct-gen rtl/plat/src/s5/design/Fadu_K2_S5_LevelGateway.v
# 구조 검증
test -d output/plat/src/s5/design/Fadu_K2_S5_LevelGateway/cmodel
test -d output/plat/src/s5/design/Fadu_K2_S5_LevelGateway/tb
```

**Expect**:
```
exit 0
```

---

## Step 6: 커밋

**Goal**: 출력 구조 구현

**Run**:
```bash
git add tools/hirct-gen/ lib/Target/
git commit -m "feat(phase-1): output structure - source tree mirroring, subdirs, top output"
```

---

## per-module Makefile 템플릿 (GenMakefile.cpp이 생성)

```makefile
# AUTO-GENERATED by hirct-gen — DO NOT EDIT
MODULE := <module_name>
RTL_SRC := <original_rtl_absolute_path>  # 프로젝트 루트 기준 절대경로
PROJECT_ROOT := <project_root_absolute_path>

.PHONY: test test-compile test-verify test-artifacts

test: test-compile test-verify test-artifacts

test-compile:
	g++ -std=c++17 -c cmodel/*.cpp

test-verify: verify/obj_dir/V${MODULE}__ALL.a
	g++ -std=c++17 -o verify/verify_${MODULE} verify/verify_${MODULE}.cpp \
		cmodel/*.cpp verify/obj_dir/V${MODULE}__ALL.a -Icmodel -Iverify/obj_dir \
		$(shell pkg-config --cflags --libs verilator)
	@for seed in $(or ${SEED},42 123 456 789 1024 2048 4096 8192 16384 32768); do \
		./verify/verify_${MODULE} 1000 $$seed || exit 1; \
	done
	@echo "PASS: all seeds"

# obj_dir 캐시: RTL 미변경 시 Verilator 빌드 스킵
verify/obj_dir/V${MODULE}__ALL.a: ${RTL_SRC}
	verilator --cc ${RTL_SRC} -Mdir verify/obj_dir --build

test-verify-rebuild:
	rm -rf verify/obj_dir
	$(MAKE) test-verify

test-artifacts:
	@echo "=== Artifact tests ==="
	verilator --lint-only -Wall wrapper/*.sv ${RTL_SRC}
	verilator --lint-only -Wall tb/*.sv ${RTL_SRC}
	g++ -std=c++17 -c dpi/*.cpp
	python3 -m py_compile cocotb/*.py
	@echo "=== All artifact tests PASS ==="
```

> **Note**: hirct-gen은 각 모듈 디렉토리에 meta.json을 항상 생성 (per-emitter 결과 기록)

---

## 게이트 (완료 기준)

- [ ] `hirct-gen rtl/plat/src/s5/design/Fadu_K2_S5_LevelGateway.v` → `output/plat/src/s5/design/Fadu_K2_S5_LevelGateway/` 생성
- [ ] 8종 서브디렉토리 존재: `cmodel/ tb/ dpi/ wrapper/ rtl/ doc/ cocotb/` (ral/은 레지스터 있을 때만)
- [ ] `Makefile` 자동 생성 확인: `test -f output/.../Makefile`
- [ ] `hirct-gen -f filelist.f --top <TopModule>` → `output/.../top/` 생성
