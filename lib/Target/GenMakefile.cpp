#include "hirct/Target/GenMakefile.h"

#include <cerrno>
#include <cstring>
#include <fstream>
#include <iostream>
#include <sys/stat.h>

namespace hirct {

GenMakefile::GenMakefile(const ModuleAnalyzer &analyzer)
    : analyzer_(analyzer) {}

bool GenMakefile::emit(const std::string &output_dir) {
  if (!analyzer_.is_valid()) {
    std::cerr << "GenMakefile: analyzer is not valid\n";
    return false;
  }

  std::string cmodel_dir = output_dir + "/cmodel";
  if (mkdir(cmodel_dir.c_str(), 0755) != 0 && errno != EEXIST) {
    std::cerr << "GenMakefile: cannot create directory: " << cmodel_dir << ": "
              << strerror(errno) << "\n";
    return false;
  }

  std::string name = analyzer_.module_name();
  std::string path = cmodel_dir + "/Makefile";

  std::ofstream ofs(path);
  if (!ofs) {
    std::cerr << "GenMakefile: cannot open " << path << "\n";
    return false;
  }

  ofs << "# AUTO-GENERATED by hirct-gen \xe2\x80\x94 DO NOT EDIT\n";
  ofs << "# Makefile for C++ model: " << name << "\n\n";
  ofs << "CXX ?= g++\n";
  ofs << "CXXFLAGS ?= -std=c++17 -Wall -Wextra -O2\n\n";
  ofs << "MODULE := " << name << "\n\n";
  ofs << ".PHONY: test-compile test-verify test-artifacts test\n\n";
  ofs << "test-compile: $(MODULE).o\n\n";
  ofs << "$(MODULE).o: $(MODULE).cpp $(MODULE).h\n";
  ofs << "\t$(CXX) $(CXXFLAGS) -c $< -o $@\n\n";
  ofs << "test-verify:\n";
  ofs << "\t@echo \"[test-verify] stub for " << name << "\"\n\n";
  ofs << "test-artifacts:\n";
  ofs << "\t@echo \"[test-artifacts] stub for " << name << "\"\n\n";
  ofs << "test: test-compile test-verify test-artifacts\n";
  ofs << "\t@echo \"[test] all tests passed for " << name << "\"\n";

  return true;
}

} // namespace hirct
